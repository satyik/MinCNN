"""
Benchmark Plotting Script for PCam

Reads history_*.json files generated by train_pcam.py and creates comparison plots.
"""

import json
import matplotlib.pyplot as plt
import glob
import os

def load_history(filepath):
    with open(filepath, 'r') as f:
        return json.load(f)

def plot_benchmark():
    # Find all history files in output/logs
    log_dir = "output/logs"
    plot_dir = "output/plots"
    os.makedirs(plot_dir, exist_ok=True)
    
    files = glob.glob(os.path.join(log_dir, "history_*.json"))
    if not files:
        print(f"No history_*.json files found in {log_dir}. Run train_pcam.py first.")
        return

    histories = []
    for f in files:
        histories.append(load_history(f))

    # Sort by model name for consistent colors
    histories.sort(key=lambda x: x['model'])

    # ── Accuracy Plot ──
    plt.figure(figsize=(10, 6))
    for h in histories:
        model_name = h['model']
        params = h['params']
        val_acc = h['val_acc']
        epochs = h['epochs']
        label = f"{model_name} ({params/1e6:.2f}M params)"
        plt.plot(epochs, val_acc, marker='o', label=label)

    plt.title("PCam Validation Accuracy Comparison")
    plt.xlabel("Epoch")
    plt.ylabel("Accuracy (%)")
    plt.grid(True, alpha=0.3)
    plt.legend()
    plt.tight_layout()
    plt.savefig(os.path.join(plot_dir, "benchmark_accuracy.png"))
    print(f"Saved {os.path.join(plot_dir, 'benchmark_accuracy.png')}")

    # ── Loss Plot ──
    plt.figure(figsize=(10, 6))
    for h in histories:
        model_name = h['model']
        val_loss = h['val_loss']
        epochs = h['epochs']
        plt.plot(epochs, val_loss, marker='x', linestyle='--', label=h['model'])

    plt.title("PCam Validation Loss Comparison")
    plt.xlabel("Epoch")
    plt.ylabel("Loss")
    plt.grid(True, alpha=0.3)
    plt.legend()
    plt.tight_layout()
    plt.savefig(os.path.join(plot_dir, "benchmark_loss.png"))
    print(f"Saved {os.path.join(plot_dir, 'benchmark_loss.png')}")

    # ── Summary Table ──
    print("\n" + "="*50)
    print(f"{'Model':<15} | {'Params':<10} | {'Best Val Acc':<12}")
    print("-" * 50)
    for h in histories:
        best_acc = max(h['val_acc'])
        print(f"{h['model']:<15} | {h['params']:<10,} | {best_acc:.2f}%")
    print("="*50 + "\n")

if __name__ == "__main__":
    plot_benchmark()
